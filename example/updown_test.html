<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>updown test</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  </head>
  <body>
    <div class="container">
      <h1>updown test</h1>
      <div class="row">
        <div class="col-xs-12">
          <button id="start" type="button">start video</button>
        </div>
        <div class="col-xs-6">
          <h2>up</h2>
          <video id="local-video" autoplay="" style="width: 400px; height: 275px; border: 1px solid black;"></video>
        </div>
        <div class="col-xs-6">
          <h2>down</h2>
          <video id="remote-video1" autoplay="" style="width: 400px; height: 275px; border: 1px solid black;"></video>
          <video id="remote-video2" autoplay="" style="width: 400px; height: 275px; border: 1px solid black;"></video>
        </div>
        <div class="col-xs-6">
          <h2>upstream connections</h2>
          <ul id="upstreams">
          </ul>
        </div>
        <div class="col-xs-6">
          <h2>downstream connections</h2>
          <ul id="downstreams">
          </ul>
        </div>
      </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="./anzu.js"></script>
    <script type="text/javascript">
var anzu = new Anzu();
var channelId = "";
var apiKey = "";
var upstreamToken = "";
var datetime = "";
var signature = "";


$("#start").on("click", function() {
  upstream();

  setTimeout(function() {
    anzu.getDownstreamToken(
      channelId,
      apiKey,
      datetime,
      signature,
      function(error, response) {
        if (error !== null) {
          console.error(error);
        }
        else {
          var downstreamToken = JSON.parse(response.text).downstreamToken;
          downstream(downstreamToken, document.getElementById("remote-video1"));
        }
      }
    );
    anzu.getDownstreamToken(
      channelId,
      apiKey,
      datetime,
      signature,
      function(error, response) {
        if (error !== null) {
          console.error(error);
        }
        else {
          var downstreamToken = JSON.parse(response.text).downstreamToken;
          downstream(downstreamToken, document.getElementById("remote-video2"));
        }
      }
    );
  }, 2000)

  setTimeout(function() {
    listConnection();
  }, 5000)
});

function upstream() {
  console.log("= upstream =");
  anzu.startUpstream(
    channelId,
    upstreamToken,
    {video: true},
    document.getElementById("local-video"),
    function() {
      console.log("- success -");
    },
    function(e) {
      console.log(e);
      console.log("- error -");
    },
    function(e) {
      console.log("- close -");
    }
  );
}

function downstream(downstreamToken, element) {
  console.log("= downstream =");
  anzu.startDownstream(
    channelId,
    downstreamToken,
    element,
    function() {
      console.log("- success -");
    },
    function(e) {
      console.log("- error -");
    },
    function(e) {
      console.log("- close -");
    }
  );
}

function listConnection() {
  anzu.listConnection(channelId, apiKey, datetime, signature, function(error, response) {
    var data = JSON.parse(response.text);
    $("#upstreams").html("");
    $("#downstreams").html("");
    $.each(data.upstreams, function(_, upstream) {
      var li = $("<li>");
      $.each(upstream, function(key, value) {
        li.append("<p>" + key + ": " + value + "</p>");
      })
      $("#upstreams").append(li);
    });
    $.each(data.downstreams, function(_, downstream) {
      var li = $("<li>");
      $.each(downstream, function(key, value) {
        li.append("<p>" + key + ": " + value + "</p>");
      })
      var button = $("<button>切断</button>");
      button.on("click", function() {
        anzu.removeConnection(downstream.channelId, downstream.clientId, apiKey, datetime, signature, function(error, response) {
          console.log("- remove connection -");
          console.log(response);
        })
      });
      li.append(button);
      $("#downstreams").append(li);
    });
  });
}

    </script>
  </body>
</html>
