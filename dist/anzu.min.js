/**
 * anzu-js-sdk
 * anzu-js-sdk
 * @version 0.1.0
 * @author Shiguredo Inc.
 * @license MIT
 */
!function(n){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.Anzu=n()}}(function(){var n;return function e(n,t,o){function r(f,s){if(!t[f]){if(!n[f]){var a="function"==typeof require&&require;if(!s&&a)return a(f,!0);if(i)return i(f,!0);var c=new Error("Cannot find module '"+f+"'");throw c.code="MODULE_NOT_FOUND",c}var u=t[f]={exports:{}};n[f][0].call(u.exports,function(e){var t=n[f][1][e];return r(t?t:e)},u,u.exports,e,n,t,o)}return t[f].exports}for(var i="function"==typeof require&&require,f=0;f<o.length;f++)r(o[f]);return r}({1:[function(n,e,t){"use strict";function o(n){return n&&n.__esModule?n:{"default":n}}function r(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function n(n,e){for(var t=0;t<e.length;t++){var o=e[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(n,o.key,o)}}return function(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}}(),f=n("sora-js-sdk"),s=o(f),a=window.mozRTCPeerConnection||window.webkitRTCPeerConnection,c=window.RTCSessionDescription||window.mozRTCSessionDescription;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var u=function(){function n(){var e=arguments.length<=0||void 0===arguments[0]?{anzuUrl:null,soraUrl:null}:arguments[0];r(this,n),this.url=null===e.anzuUrl?"https://anzu.shiguredo.jp/api/":e.anzuUrl,this.sora=new s["default"](null===e.soraUrl?"wss://anzu.shiguredo.jp/signaling":e.soraUrl),this.upstreamPc,this.downstreamPc={}}return i(n,[{key:"startUpstream",value:function(n,e,t,o,r,i,f){var s=this,u=function(n){return new Promise(function(e,t){navigator.getUserMedia?navigator.getUserMedia(n,function(n){e(n)},function(n){t(n)}):t(message)})},d=function(n){s.sdplog("Upstream Offer",n.offer);var e=n.offer,t=n.stream;return new Promise(function(n,o){var r=new a({iceServers:e.iceServers});r.addStream(t),n({pc:r,offer:e})})},l=function(n){var e=n.pc,t=n.offer;return new Promise(function(o,r){e.setRemoteDescription(new c(t),function(){e.createAnswer(function(r){s.sdplog("Upstream answer",n.offer),o({pc:e,answer:r,offer:t})},function(n){r(n)})},function(n){r(n)})})},p=this.sora.connection(function(){u(t).then(function(t){return new Promise(function(r,i){o.src=window.URL.createObjectURL(t),o.play();var f={role:"upstream",channelId:n,accessToken:e};p.connect(f,function(n){r({offer:n,stream:t})},function(n){i(n)})})}).then(d).then(l).then(function(n){return new Promise(function(e,t){var o=n.pc,r=n.answer;n.offer;o.setLocalDescription(r,function(){p.answer(r.sdp),s.upstreamPc=o,e(n.offer.clientId),o.onicecandidate=function(n){null!==n.candidate&&(console.info("====== candidate ======"),console.info(n.candidate),p.candidate(n.candidate))}},function(n){t(n)})})}).then(function(n){r(n)})["catch"](function(n){i(n)})},i,function(n){o.pause(),o.src="",p=null,s.upstreamPc=null,f(n)})}},{key:"startDownstream",value:function(n,e,t,o,r,i){var f=this,s=function(n){return f.sdplog("Downstream offer",n.offer),new Promise(function(e,t){var o=n.offer,r=new a({iceServers:o.iceServers});e({pc:r,offer:o})})},u=function(n){var e=n.pc,o=n.offer;return new Promise(function(r,i){e.setRemoteDescription(new c(o),function(){e.createAnswer(function(t){f.sdplog("Downstream answer",n.offer),r({pc:e,offer:o,answer:t})},function(n){i(n)})},function(n){i(n)}),e.onaddstream=function(n){t.src=window.URL.createObjectURL(n.stream),t.play()}})},d=this.sora.connection(function(){new Promise(function(t,o){var r={role:"downstream",channelId:n,accessToken:e};d.connect(r,function(n){t({offer:n})},function(n){o(n)})}).then(s).then(u).then(function(n){return new Promise(function(e,t){var o=n.pc,i=n.answer,s=n.offer.clientId;o.setLocalDescription(i,function(){d.answer(i.sdp),f.downstreamPc[s]=o,e(s),o.onicecandidate=function(n){null!==n.candidate&&(console.info("====== candidate ======"),console.info(n.candidate),d.candidate(n.candidate))}},r)})}).then(function(n){o(n)})["catch"](function(n){r(n)})},r,function(n){t.pause(),t.src="",i(n)})}},{key:"sdplog",value:function(n,e){console.info("========== "+n+" ==========");for(var t in e)console.info(t+":"),console.info(e[t])}}]),n}();e.exports=u},{"sora-js-sdk":2}],2:[function(e,t,o){(function(r){!function(e){if("object"==typeof o&&"undefined"!=typeof t)t.exports=e();else if("function"==typeof n&&n.amd)n([],e);else{var i;i="undefined"!=typeof window?window:"undefined"!=typeof r?r:"undefined"!=typeof self?self:this,i.Sora=e()}}(function(){return function n(t,o,r){function i(s,a){if(!o[s]){if(!t[s]){var c="function"==typeof e&&e;if(!a&&c)return c(s,!0);if(f)return f(s,!0);var u=new Error("Cannot find module '"+s+"'");throw u.code="MODULE_NOT_FOUND",u}var d=o[s]={exports:{}};t[s][0].call(d.exports,function(n){var e=t[s][1][n];return i(e?e:n)},d,d.exports,n,t,o,r)}return o[s].exports}for(var f="function"==typeof e&&e,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(n,e,t){"use strict";function o(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var r=function(){function n(n,e){for(var t=0;t<e.length;t++){var o=e[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(n,o.key,o)}}return function(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}}(),i=function(){function n(e){o(this,n),this.url=e||""}return r(n,[{key:"connection",value:function(n){var e=arguments.length<=1||void 0===arguments[1]?function(){}:arguments[1],t=arguments.length<=2||void 0===arguments[2]?function(){}:arguments[2];return new f(this.url,n,e,t)}}]),n}(),f=function(){function n(e,t,r,i){o(this,n),this._ws=new WebSocket(e),this._onClose=i,this._ws.onopen=function(){t()},this._ws.onerror=function(n){r(n)},this._ws.onclose=function(n){i(n)}}return r(n,[{key:"connect",value:function(n,e,t){var o=this,r=this;this._ws.onclose=function(n){4401===n.code?t(n):o._onClose(n),r._ws=null},this._ws.onmessage=function(n){var t=JSON.parse(n.data);"offer"==t.type?e(t):"ping"==t.type&&r._ws.send(JSON.stringify({type:"pong"}))};var i=JSON.stringify({type:"connect",role:n.role,channelId:n.channelId,accessToken:n.accessToken});this._ws.send(i)}},{key:"answer",value:function(n){this._ws.send(JSON.stringify({type:"answer",sdp:n}))}},{key:"candidate",value:function(n){var e=n.toJSON();e.type="candidate",this._ws.send(JSON.stringify(e))}}]),n}();e.exports=i},{}]},{},[1])(1)})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[1])(1)});