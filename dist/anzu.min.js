/*!
 * anzu-js-sdk
 * WebRTC SFU as a Service Anzu Library
 * @version 0.6.0
 * @author Shiguredo Inc.
 * @license MIT
 */
!function(n){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=n();else if("function"==typeof define&&define.amd)define([],n);else{var e;e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,e.Anzu=n()}}(function(){var n;return function e(n,t,o){function i(c,a){if(!t[c]){if(!n[c]){var s="function"==typeof require&&require;if(!a&&s)return s(c,!0);if(r)return r(c,!0);var u=new Error("Cannot find module '"+c+"'");throw u.code="MODULE_NOT_FOUND",u}var f=t[c]={exports:{}};n[c][0].call(f.exports,function(e){var t=n[c][1][e];return i(t?t:e)},f,f.exports,e,n,t,o)}return t[c].exports}for(var r="function"==typeof require&&require,c=0;c<o.length;c++)i(o[c]);return i}({1:[function(e,t,o){(function(i){/*!
 * sora-js-sdk
 * WebRTC SFU Sora Signaling Library
 * @version 0.5.0
 * @author Shiguredo Inc.
 * @license MIT
 */
!function(e){if("object"==typeof o&&"undefined"!=typeof t)t.exports=e();else if("function"==typeof n&&n.amd)n([],e);else{var r;r="undefined"!=typeof window?window:"undefined"!=typeof i?i:"undefined"!=typeof self?self:this,r.Sora=e()}}(function(){return function n(t,o,i){function r(a,s){if(!o[a]){if(!t[a]){var u="function"==typeof e&&e;if(!s&&u)return u(a,!0);if(c)return c(a,!0);var f=new Error("Cannot find module '"+a+"'");throw f.code="MODULE_NOT_FOUND",f}var d=o[a]={exports:{}};t[a][0].call(d.exports,function(n){var e=t[a][1][n];return r(e?e:n)},d,d.exports,n,t,o,i)}return o[a].exports}for(var c="function"==typeof e&&e,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(n,e,t){"use strict";function o(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var i=function(){function n(n,e){for(var t=0;t<e.length;t++){var o=e[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(n,o.key,o)}}return function(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}}(),r=function(){function n(e){o(this,n),this.url=e||""}return i(n,[{key:"connection",value:function(){return new c(this.url)}}]),n}(),c=function(){function n(e){o(this,n),this._ws=null,this._url=e,this._onerror=function(){},this._onclose=function(){}}return i(n,[{key:"connect",value:function(n){var e=this;return new Promise(function(t,o){null===e._ws&&(e._ws=new WebSocket(e._url)),e._ws.onopen=function(){var t={type:"connect",role:n.role,channel_id:n.channelId,access_token:n.accessToken,multistream:n.multistream};n.codecType&&(t.video={codec_type:n.codecType}),e._ws.send(JSON.stringify(t))},e._ws.onclose=function(n){/440\d$/.test(n.code)?o(n):e._onclose(n)},e._ws.onerror=function(n){e._onerror(n)},e._ws.onmessage=function(n){var o=JSON.parse(n.data);"offer"==o.type?t(o):"ping"==o.type&&e._ws.send(JSON.stringify({type:"pong"}))}})}},{key:"answer",value:function(n){this._ws.send(JSON.stringify({type:"answer",sdp:n}))}},{key:"candidate",value:function(n){var e=n.toJSON();e.type="candidate",this._ws.send(JSON.stringify(e))}},{key:"onError",value:function(n){this._onerror=n}},{key:"onDisconnect",value:function(n){this._onclose=n}},{key:"disconnect",value:function(){this._ws.close(),this._ws=null}}]),n}();e.exports=r},{}]},{},[1])(1)})}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(n,e,t){"use strict";function o(n){return n&&n.__esModule?n:{"default":n}}function i(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&"function"==typeof Symbol&&n.constructor===Symbol?"symbol":typeof n},c=function(){function n(n,e){for(var t=0;t<e.length;t++){var o=e[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(n,o.key,o)}}return function(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}}(),a=n("sora-js-sdk"),s=o(a),u=window.mozRTCPeerConnection||window.webkitRTCPeerConnection,f=window.RTCSessionDescription||window.mozRTCSessionDescription;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;var d=function(){function n(e){var t=arguments.length<=1||void 0===arguments[1]?{anzuUrl:null,signalingUrl:null}:arguments[1];if(i(this,n),this.anzuUrl=null===t.anzuUrl?"https://anzu.shiguredo.jp/api/":t.anzuUrl,this.signalingUrl=null===t.signalingUrl?"wss://anzu.shiguredo.jp/signaling":t.signalingUrl,"upstream"!==e&&"downstream"!==e){var o=new Error("Role "+e+" is not defined");throw o}this.role=e,this._onError=function(){},this._onDisconnect=function(){}}return c(n,[{key:"start",value:function(n,e){var t=arguments.length<=2||void 0===arguments[2]?null:arguments[2],o=arguments.length<=3||void 0===arguments[3]?"VP8":arguments[3],i=arguments.length<=4||void 0===arguments[4]?!1:arguments[4];if("upstream"===this.role){var r=null===t?{video:!0,audio:!0}:t;return this._startUpstream(n,e,r,o,i)}return"downstream"===this.role?this._startDownstream(n,e,o,i):void 0}},{key:"_startUpstream",value:function(n,e,t,o,i){var r=this,c=function(n){return new Promise(function(e,t){navigator.getUserMedia?navigator.getUserMedia(n,function(t){r.trace("Upstream getUserMedia constraints",n),r.stream=t,e({stream:t})},function(n){t(n)}):t()})},a=function(){return r.sora=new s["default"](r.signalingUrl).connection(),r.sora.onError(r._onError),r.sora.onDisconnect(r._onDisconnect),r.sora.connect({role:"upstream",channelId:n,accessToken:e,codecType:o,multistream:i})},d=function(n){return r.trace("Upstream Offer sdp",n.sdp),r.trace("Upstream Offer clientId",n.client_id),r.trace("Upstream Offer config",n.config),new Promise(function(e,t){r.clientId=n.client_id,r.pc=new u(n.config),r.pc.addStream(r.stream),e(n)})},l=function(n){return new Promise(function(e,t){r.pc.oniceconnectionstatechange=function(n){switch(r.trace("Upstream oniceconnectionstatechange",{iceConnectionState:r.pc.iceConnectionState,iceGatheringState:r.pc.iceGatheringState}),r.pc.iceConnectionState){case"connected":case"completed":e({clientId:r.clientId,stream:r.stream});break;case"failed":t(n)}},r.pc.onicecandidate=function(n){r.trace("Upstream onicecandidate",{candidate:n.candidate,iceConnectionState:r.pc.iceConnectionState,iceGatheringState:r.pc.iceGatheringState}),null!==n.candidate&&r.sora.candidate(n.candidate)},r.pc.setRemoteDescription(new f(n),function(){r.pc.createAnswer(function(n){r.trace("Upstream answer sdp",n.sdp),r.pc.setLocalDescription(n,function(){r.sora.answer(n.sdp)},function(n){t(n)})},function(n){t(n)})},function(n){t(n)})})};return c(t).then(a).then(d).then(l)["catch"](function(n){return r.disconnect(),Promise.reject(n)})}},{key:"_startDownstream",value:function(n,e,t,o){var i=this,r=function(){return i.sora=new s["default"](i.signalingUrl).connection(),i.sora.onError(i._onError),i.sora.onDisconnect(i._onDisconnect),i.sora.connect({role:"downstream",channelId:n,accessToken:e,codecType:t,multistream:o})},c=function(n){return i.trace("Downstream offer sdp",n.sdp),i.trace("Downstream offer clientId",n.client_id),i.trace("Downstream offer config",n.config),new Promise(function(e,t){i.clientId=n.client_id,i.pc=new u(n.config),e(n)})},a=function(n){return i.icecandidateConnected=!1,i.addstreamCompleted=!1,new Promise(function(e,t){i.pc.onaddstream=function(n){i.addstreamCompleted=!0,i.stream=n.stream,i.trace("Downstream onaddstream",n.stream.id),i.icecandidateConnected&&e({clientId:i.clientId,stream:i.stream})},i.pc.oniceconnectionstatechange=function(n){switch(i.trace("Downstream oniceconnectionstatechange",{iceConnectionState:i.pc.iceConnectionState,iceGatheringState:i.pc.iceGatheringState}),i.pc.iceConnectionState){case"connected":case"completed":i.icecandidateConnected=!0,i.addstreamCompleted&&e({clientId:i.clientId,stream:i.stream});break;case"failed":t(n)}},i.pc.onicecandidate=function(n){i.trace("Downstream onicecandidate",{candidate:n.candidate,iceConnectionState:i.pc.iceConnectionState,iceGatheringState:i.pc.iceGatheringState}),null!==n.candidate&&i.sora.candidate(n.candidate)},i.pc.setRemoteDescription(new f(n),function(){i.pc.createAnswer(function(n){i.trace("Downstream answer sdp",n.sdp),i.pc.setLocalDescription(n,function(){i.sora.answer(n.sdp)},function(n){t(n)})},function(n){t(n)})},function(n){t(n)})})};return r().then(c).then(a)["catch"](function(n){return i.disconnect(),Promise.reject(n)})}},{key:"trace",value:function(n,e){var t="";window.performance&&(t=(window.performance.now()/1e3).toFixed(3)+": "),"object"===("undefined"==typeof e?"undefined":r(e))&&null!==e?console.info(t+n+"\n"+JSON.stringify(e,null,2)):console.info(t+n+"\n"+e)}},{key:"disconnect",value:function(){this.stream&&this.stream.getTracks().forEach(function(n){n.stop()}),this.stream=null,this.sora&&this.sora.disconnect(),this.sora=null,this.pc&&"closed"!==this.pc.signalingState&&(this.pc.oniceconnectionstatechange=null,this.pc.close()),this.pc=null}},{key:"onError",value:function(n){this._onError=n,this.sora&&this.sora.onError(n)}},{key:"onDisconnect",value:function(n){this._onDisconnect=n,this.sora&&this.sora.onDisconnect(n)}}]),n}();e.exports=d},{"sora-js-sdk":1}]},{},[2])(2)});